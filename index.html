<html data-theme="dark">

<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />
    <title>title</title>

    <link rel="stylesheet" href="./style.css" />

    <script src="script.js"></script>

    <script>

        // Messages

        function loadMessages(data) {
            data.messages = Messages.list()
        }

        function addMessage(data, message) {
            if (!message.content) return

            let addedMessage = Messages.add(message)

            data.messages.push(addedMessage)
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 1)
        }

        async function addMessageStream(data, stream) {
            var message = {
                role: 'assistant',
                content: ''
            }

            data.messages.push(message)
            for await (const value of stream) {
                data.messages[data.messages.length - 1].content += value
            }

            data.reader = undefined
            data.busy = false

            const content = data.messages[data.messages.length - 1].content
            if (!content) return

            data.messages[data.messages.length - 1] = Messages.add(message)
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 1)
        }

        async function sendMessage(data, message) {
            data.content = ''
            data.busy = true

            if (!!message.content) addMessage(data, message)

            const response = Completions.send()
            data.reader = (await response.next()).value

            if (!!data.reader) addMessageStream(data, response)
        }

        function alterTextArea(textArea) {
            textArea.style.height = 'auto';
            textArea.style.height = (textArea.scrollHeight + 2) + 'px';
        }

        function checkSubmit(e, data) {
            if (e.key == 'Enter' && !e.shiftKey && !data.busy) {
                e.preventDefault()
                sendMessage(data, { role: 'user', content: data.content })
            }
        }

        function deleteMessage(data, message) {
            const index = data.messages.indexOf(message)
            data.messages.splice(index, 1)
            Messages.remove(message.id)
        }

        // Profile
        function loadProfile(data) {
            const profile = Profile.get()
            data.base_url = profile.base_url
            data.api_key = profile.api_key
            data.model = profile.model
            data.model_override = profile.model_override
            data.main = profile.main
            data.jailbreak = profile.jailbreak
        }
        function updateProfile(data) {
            const profile = Profile.get()
            updated = {
                base_url: data.base_url,
                api_key: data.api_key,
                model: data.model,
                model_override: data.model_override,
                main: data.main,
                jailbreak: data.jailbreak
            }

            Object.keys(updated).forEach(key => updated[key] === undefined && delete updated[key]);

            console.log({ ...profile, ...updated })

            Profile.update({ ...profile, ...updated })
        }

        async function loadModels(data){
            data.models = await Completions.models()
        }

        document.addEventListener('alpine:init', () => {
            Alpine.store('modalConnection', false)
            Alpine.store('modalCharacter', false)
        })

    </script>
</head>

<body x-data="{messages: []}">
    <header class="container-fluid">
        <nav>
            <ul>
                <li> <strong>This is not tavern</strong> </li>
            </ul>

            <ul>
                <li>
                    <button class="button-icon" x-on:click="$store.modalConnection=true">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="currentColor">
                            <path
                                d="M440-120v-240h80v80h320v80H520v80h-80Zm-320-80v-80h240v80H120Zm160-160v-80H120v-80h160v-80h80v240h-80Zm160-80v-80h400v80H440Zm160-160v-240h80v80h160v80H680v80h-80Zm-480-80v-80h400v80H120Z" />
                        </svg>
                    </button>
                </li>
                <li>
                    <button class="button-icon" x-on:click="$store.modalCharacter=true">
                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="currentColor">
                            <path
                                d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-160v-112q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v112H160Zm80-80h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z" />
                        </svg>
                    </button>
                </li>
            </ul>

        </nav>
    </header>

    <main x-ref="messages" x-init="loadMessages($data)" class="container-fluid">

        <template x-for="message in messages">
            <article>
                <header>
                    <strong x-text="message.role">Assistant</strong>
                    <button x-on:click="deleteMessage($data, message)" style="float: right;" class="button-icon cancel">
                        <svg xmlns="http://www.w3.org/2000/svg" height="18px" width="18px" viewBox="0 -960 960 960"
                            fill="currentColor">
                            <path
                                d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
                        </svg>
                    </button>
                </header>
                <main x-bind:aria-busy="!message.content" x-html="marked.parse(message.content)">lol</main>
            </article>
        </template>
    </main>

    <footer x-data="{content: '', reader: undefined, busy: false}" class="container-fluid"
        style="display: flex; padding-right: 0px;">

        <textarea x-init="$watch('content', value => alterTextArea($el))" x-on:keydown="checkSubmit($event, $data)"
            x-bind:disabled="busy" x-ref="messageInput" x-model="content" placeholder="Enter your message" rows="1"
            cols="50" spellcheck="false" style="resize: none; overflow: hidden; margin-bottom: 0px;"></textarea>

        <div style="width: 64px; display: flex; align-items: center; justify-content: center;">

            <button x-bind:disabled="busy" x-show="!reader"
                x-on:click="sendMessage($data, {role: 'user', content: content} );" class="button-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960"
                    fill="currentColor">
                    <path
                        d="M120-160v-640l760 320-760 320Zm80-120 474-200-474-200v140l240 60-240 60v140Zm0 0v-400 400Z" />
                </svg>
            </button>

            <button x-show="!!reader" x-on:click="reader.cancel()" class="cancel button-icon">
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="currentColor">
                    <path
                        d="m336-280 144-144 144 144 56-56-144-144 144-144-56-56-144 144-144-144-56 56 144 144-144 144 56 56ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
                </svg>
            </button>

        </div>

    </footer>

    <dialog x-bind:open="$store.modalConnection">
        <article>
            <header>
                <strong>OpenAI compaitable API</strong>

                <button x-on:click="$store.modalConnection=false" style="padding: 4px;" class="button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"
                        fill="currentColor">
                        <path
                            d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                    </svg>
                </button>
            </header>
            <main>
                <form x-data="{base_url: '', api_key: '', model: '', model_override: '', models: []}" x-init="loadProfile($data)">
                    <label>Base URL</label>
                    <input x-model="base_url" x-on:blur="updateProfile($data)">
                    <small>Should end with / </small>

                    <label>API key</label>
                    <input x-model="api_key" x-on:blur="updateProfile($data)">

                    <label>Model</label>
                    <select x-model="model" x-on:blur="updateProfile($data)">
                        <template x-for="model in models"> 
                            <option x-text="model">gpt-4o</option> 
                        </template>
                    </select>

                    <label>Model override</label>
                    <input x-model="model_override" x-on:blur="updateProfile($data)">

                    <hr>

                    <input x-on:click="loadModels($data)" type="button" value="Get models" class="outline">
                    <input x-on:click="$store.modalConnection=false" type="button" value="Apply">
                </form>
            </main>
        </article>
    </dialog>

    <dialog x-bind:open="$store.modalCharacter">
        <article>
            <header>
                <strong>Character definitions</strong>

                <button x-on:click="$store.modalCharacter=false" style="padding: 4px;" class="button-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px"
                        fill="currentColor">
                        <path
                            d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
                    </svg>
                </button>
            </header>
            <main>
                <form x-data="{main: '', jailbreak: ''}" x-init="loadProfile($data)">
                    <label>Main prompt</label>
                    <textarea rows="4" x-model="main" x-on:blur="updateProfile($data)"></textarea>
                    <small>Inserted before first message</small>

                    <label>Jailbreak</label>
                    <textarea rows="4" x-model="jailbreak" x-on:blur="updateProfile($data)"></textarea>
                    <small>Inserted after last message</small>

                    <hr>
                    <input x-on:click="$store.modalCharacter=false" type="button" value="Apply">
                </form>
            </main>
        </article>
    </dialog>


</body>

</html>